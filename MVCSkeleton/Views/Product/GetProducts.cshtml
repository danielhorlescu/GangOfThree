@using MVCSkeleton.Presentation.Controls
@model List<MVCSkeleton.Presentation.Models.ProductModel>

@{
    ViewBag.Title = "Products";
}

<h2>Products</h2>

<label for="ProductsGrid">Products:</label>
    @Html.ValidationSummary()

    @(Html.Controls().Grid(Model)    
      .Name("ProductsGrid")
      .Columns(columns =>
          {
              columns.Bound(p => p.Name).ClientTemplate("<a href='" + Url.Action("Edit", "Product", new {id = "#=Id#"}) + " '>#=Name#</a>");
              columns.Bound(p => p.Code);
              columns.Bound(p => p.UnitPrice).Width(120);
              columns.Bound(p => p.UnitsInStock).Width(150);
              columns.Command(command => command.Destroy());
          })
      .ToolBar(toolbar =>
          {
              toolbar.Custom().Action("Edit", "Product").Text("Create New");
              toolbar.Custom().Text("Delete All").HtmlAttributes(new Dictionary<string, object>{{"id", "deleteAll"}});
          })
      .Groupable()
      .Pageable()
      .Sortable()
      .Scrollable()
      .Selectable(selectable => selectable.Mode(GridSelectionMode.Multiple))
      .Filterable()
      .Events(config => config.DataBound("onDataBound"))
      .DataSource(ds => ds.Ajax()
                          .Batch(true)
                          .Read(read => read.Action("Products_Read", "Product"))
                          .Events(events => events.Error("error"))
                          .Model(model => model.Id(p => p.Id))
                          .Create(create => create.Action("Product_Create", "Product"))
                          .Destroy(destroy => destroy.Action("Product_Delete", "Product"))
                          .Update(update => update.Action("Product_Update", "Product"))))  
<br/>
<input type="button" id="refreshProductsGridData" value="Refresh Data" onclick="$('#ProductsGrid').data('kendoGrid').dataSource.read();" />
<script type="text/javascript">
    //kendo.data.DataSource.prototype.options.autoSync = true;
    $('#body').kendoValidator().data('kendoValidator');
    function error(e) {
        console.log(e.errors);
        alert('An error occured!');
        $('#ProductsGrid').data('kendoGrid').cancelChanges();
    }

    $("#deleteAll").click(function() {

        var gridRows = $("#ProductsGrid").data("kendoGrid");
        var items = new Array();

        gridRows.select().each(function() {
            var dataItem = gridRows.dataItem($(this));
            items.push(dataItem);
        });

        $.ajax({
            type: "POST",
            url: "/Product/DeleteAll",
            data: JSON.stringify({ selectedProducts: items }),
            dataType: "html",
            contentType: "application/json; charset=utf-8"
        });
    });
    
    function onDataBound(e) {
        var grid = e.sender;
        grid.element.find("tr[role='row']").each(function () {
            var dataItem = grid.dataItem(this);
            $(this).attr('data-id', dataItem.Id);
        });
    }
</script>